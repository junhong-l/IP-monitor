<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPåœ°å€ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .ip-list {
            margin-top: 15px;
        }

        .ip-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .ip-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .ip-item p {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }

        .ip-item .no-data {
            color: #999;
            font-style: italic;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .smtp-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .smtp-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .smtp-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .smtp-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-switch {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: #f0f4ff;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .interval-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .interval-btn {
            padding: 8px 16px;
            border: 2px solid #28a745;
            border-radius: 20px;
            background: white;
            color: #28a745;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .interval-btn:hover {
            background: #28a745;
            color: white;
        }

        .interval-btn.active {
            background: #28a745;
            color: white;
        }

        .monitor-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
        }

        .status-dot.running {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.stopped {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .button-group {
                flex-direction: column;
            }

            .btn-secondary {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ IPåœ°å€ç›‘æ§ç³»ç»Ÿ</h1>
            <p>è‡ªåŠ¨ç›‘æ§å¹¶é€šçŸ¥IPåœ°å€å˜åŒ–</p>
        </div>

        <div id="message" class="message"></div>

        <!-- é…ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ“§ é‚®ä»¶é…ç½®</h2>
            <form id="configForm">
                <div class="form-group">
                    <label for="senderEmail">å‘ä»¶äººé‚®ç®±ï¼š</label>
                    <input type="email" id="senderEmail" required placeholder="example@gmail.com">
                </div>

                <div class="form-group">
                    <label for="senderPassword">é‚®ç®±å¯†ç /æˆæƒç ï¼š</label>
                    <input type="password" id="senderPassword" placeholder="ç•™ç©ºåˆ™ä¿æŒä¸å˜">
                    <small>å¯¹äºGmailã€QQé‚®ç®±ç­‰ï¼Œéœ€è¦ä½¿ç”¨æˆæƒç è€Œéç™»å½•å¯†ç </small>
                </div>

                <div class="form-group">
                    <label for="smtpServer">SMTPæœåŠ¡å™¨ï¼š</label>
                    <div class="smtp-presets">
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.qq.com', 587)">ğŸ“§ QQé‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.163.com', 587)">ğŸ“§ 163é‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.gmail.com', 587)">ğŸ“§ Gmail</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.exmail.qq.com', 587)">ğŸ“§ è…¾è®¯ä¼ä¸šé‚®</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp-mail.outlook.com', 587)">ğŸ“§ Outlook</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.126.com', 587)">ğŸ“§ 126é‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.sina.com', 587)">ğŸ“§ æ–°æµªé‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.aliyun.com', 465)">ğŸ“§ é˜¿é‡Œäº‘é‚®ç®±</button>
                    </div>
                    <input type="text" id="smtpServer" required placeholder="smtp.gmail.com" style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label for="smtpPort">SMTPç«¯å£ï¼š</label>
                    <input type="number" id="smtpPort" required placeholder="587">
                    <small>å¸¸ç”¨ç«¯å£: 587(TLS), 465(SSL), 25(éåŠ å¯†)</small>
                </div>

                <div class="form-group">
                    <label for="recipients">æ”¶ä»¶äººé‚®ç®±ï¼š</label>
                    <textarea id="recipients" required placeholder="æ¯è¡Œä¸€ä¸ªé‚®ç®±åœ°å€&#10;example1@gmail.com&#10;example2@gmail.com"></textarea>
                    <small>å¯ä»¥è®¾ç½®å¤šä¸ªæ”¶ä»¶äººï¼Œæ¯è¡Œä¸€ä¸ªé‚®ç®±åœ°å€</small>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button type="button" class="btn btn-secondary" onclick="testEmail()">âœ‰ï¸ å‘é€æµ‹è¯•é‚®ä»¶</button>
                </div>
            </form>
        </div>

        <!-- ç›‘æ§è®¾ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>âš™ï¸ ç›‘æ§è®¾ç½®</h2>
            <div class="form-group">
                <label>ç›‘æ§æ¨¡å¼ï¼š</label>
                <div class="mode-switch">
                    <button type="button" class="mode-btn" id="modeManual" onclick="setMode(false)">ğŸ–ï¸ æ‰‹åŠ¨æ¨¡å¼</button>
                    <button type="button" class="mode-btn" id="modeAuto" onclick="setMode(true)">â° è‡ªåŠ¨æ¨¡å¼</button>
                </div>
                <small>æ‰‹åŠ¨æ¨¡å¼éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ£€æŸ¥ï¼Œè‡ªåŠ¨æ¨¡å¼ä¼šå®šæ—¶æ£€æŸ¥IPå˜åŒ–</small>
            </div>

            <div class="form-group" id="intervalGroup" style="display: none;">
                <label for="intervalMinutes">æ£€æµ‹é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                <div class="interval-presets">
                    <button type="button" class="interval-btn" onclick="setInterval(5)">5åˆ†é’Ÿ</button>
                    <button type="button" class="interval-btn" onclick="setInterval(10)">10åˆ†é’Ÿ</button>
                    <button type="button" class="interval-btn" onclick="setInterval(30)">30åˆ†é’Ÿ</button>
                    <button type="button" class="interval-btn" onclick="setInterval(60)">1å°æ—¶</button>
                    <button type="button" class="interval-btn" onclick="setInterval(120)">2å°æ—¶</button>
                    <button type="button" class="interval-btn" onclick="setInterval(360)">6å°æ—¶</button>
                </div>
                <input type="number" id="intervalMinutes" min="1" max="1440" value="30" style="margin-top: 10px;">
                <small>è®¾ç½®è‡ªåŠ¨æ£€æµ‹IPå˜åŒ–çš„æ—¶é—´é—´éš”ï¼Œæœ€å°1åˆ†é’Ÿï¼Œæœ€å¤§1440åˆ†é’Ÿï¼ˆ24å°æ—¶ï¼‰</small>
            </div>

            <div id="monitorStatus" class="monitor-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ç›‘æ§çŠ¶æ€: æœªçŸ¥</span>
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button type="button" class="btn btn-primary" onclick="saveMonitorConfig()">ğŸ’¾ ä¿å­˜ç›‘æ§è®¾ç½®</button>
                <button type="button" class="btn btn-secondary" onclick="checkIPNow()">ğŸ” ç«‹å³æ£€æŸ¥IP</button>
            </div>
        </div>

        <!-- IPä¿¡æ¯å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ” å½“å‰IPåœ°å€ä¿¡æ¯</h2>
            <button class="btn btn-primary" onclick="refreshIPs()" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°IPä¿¡æ¯</button>
            <div id="ipInfo" class="ip-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è·å–IPä¿¡æ¯...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®å’ŒIPä¿¡æ¯
        window.onload = function() {
            loadConfig();
            refreshIPs();
            loadMonitorStatus();
        };

        // å½“å‰æ¨¡å¼
        let currentAutoMode = false;

        // è®¾ç½®SMTPé¢„è®¾
        function setSmtp(server, port) {
            document.getElementById('smtpServer').value = server;
            document.getElementById('smtpPort').value = port;
            
            // é«˜äº®å½“å‰é€‰ä¸­çš„æŒ‰é’®
            document.querySelectorAll('.smtp-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            showMessage('å·²é€‰æ‹©: ' + server + ':' + port, 'success');
        }

        // è®¾ç½®ç›‘æ§æ¨¡å¼
        function setMode(autoMode) {
            currentAutoMode = autoMode;
            document.getElementById('modeManual').classList.toggle('active', !autoMode);
            document.getElementById('modeAuto').classList.toggle('active', autoMode);
            document.getElementById('intervalGroup').style.display = autoMode ? 'block' : 'none';
        }

        // è®¾ç½®æ—¶é—´é—´éš”
        function setInterval(minutes) {
            document.getElementById('intervalMinutes').value = minutes;
            document.querySelectorAll('.interval-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // åŠ è½½ç›‘æ§çŠ¶æ€
        async function loadMonitorStatus() {
            try {
                const response = await fetch('/api/monitor/status');
                const status = await response.json();
                
                currentAutoMode = status.auto_mode;
                setMode(status.auto_mode);
                document.getElementById('intervalMinutes').value = status.interval_minutes || 30;
                
                updateStatusDisplay(status.running);
            } catch (error) {
                console.error('åŠ è½½ç›‘æ§çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(running) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            dot.className = 'status-dot ' + (running ? 'running' : 'stopped');
            
            if (currentAutoMode) {
                text.textContent = running ? 
                    'ç›‘æ§çŠ¶æ€: è‡ªåŠ¨ç›‘æ§è¿è¡Œä¸­ âœ…' : 
                    'ç›‘æ§çŠ¶æ€: è‡ªåŠ¨ç›‘æ§å·²åœæ­¢ â¸ï¸';
            } else {
                text.textContent = 'ç›‘æ§çŠ¶æ€: æ‰‹åŠ¨æ¨¡å¼ ğŸ–ï¸';
            }
        }

        // ä¿å­˜ç›‘æ§é…ç½®
        async function saveMonitorConfig() {
            const config = {
                auto_mode: currentAutoMode,
                interval_minutes: parseInt(document.getElementById('intervalMinutes').value)
            };

            try {
                const response = await fetch('/api/config/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showMessage('ç›‘æ§è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    setTimeout(loadMonitorStatus, 500);
                } else {
                    showMessage('ä¿å­˜ç›‘æ§è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜ç›‘æ§è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }

        // ç«‹å³æ£€æŸ¥IP
        async function checkIPNow() {
            showMessage('æ­£åœ¨æ£€æŸ¥IPåœ°å€...', 'success');
            
            try {
                const response = await fetch('/api/check-ip', { method: 'POST' });
                const result = await response.json();
                
                if (result.changed) {
                    showMessage(result.message + ' (æ—§: ' + (result.old_ips.join(', ') || 'æ— ') + ' â†’ æ–°: ' + result.current_ips.join(', ') + ')', 'success');
                } else {
                    showMessage('IPåœ°å€æ— å˜åŒ–: ' + result.current_ips.join(', '), 'success');
                }
                
                refreshIPs();
            } catch (error) {
                showMessage('æ£€æŸ¥IPå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('senderEmail').value = config.sender_email || '';
                document.getElementById('smtpServer').value = config.smtp_server || '';
                document.getElementById('smtpPort').value = config.smtp_port || 587;
                
                if (config.recipients && config.recipients.length > 0) {
                    document.getElementById('recipients').value = config.recipients.join('\n');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜é…ç½®
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const recipients = document.getElementById('recipients').value
                .split('\n')
                .map(email => email.trim())
                .filter(email => email.length > 0);

            const config = {
                sender_email: document.getElementById('senderEmail').value,
                sender_password: document.getElementById('senderPassword').value,
                smtp_server: document.getElementById('smtpServer').value,
                smtp_port: parseInt(document.getElementById('smtpPort').value),
                recipients: recipients
            };

            try {
                const response = await fetch('/api/config/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showMessage('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    document.getElementById('senderPassword').value = '';
                } else {
                    showMessage('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        });

        // åˆ·æ–°IPä¿¡æ¯
        async function refreshIPs() {
            const ipInfoDiv = document.getElementById('ipInfo');
            ipInfoDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨è·å–IPä¿¡æ¯...</p></div>';

            try {
                const response = await fetch('/api/ips');
                const ips = await response.json();

                let html = '';

                html += '<div class="ip-item">';
                html += '<h4>ğŸŒ å…¬ç½‘ IPv4</h4>';
                html += '<p>' + (ips.public_ipv4 && ips.public_ipv4.length > 0 ? ips.public_ipv4.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                html += '<div class="ip-item">';
                html += '<h4>ğŸŒ å…¬ç½‘ IPv6</h4>';
                html += '<p>' + (ips.public_ipv6 && ips.public_ipv6.length > 0 ? ips.public_ipv6.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                html += '<div class="ip-item">';
                html += '<h4>ğŸ  ç§æœ‰ IPv4</h4>';
                html += '<p>' + (ips.private_ipv4 && ips.private_ipv4.length > 0 ? ips.private_ipv4.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                html += '<div class="ip-item">';
                html += '<h4>ğŸ  ç§æœ‰ IPv6</h4>';
                html += '<p>' + (ips.private_ipv6 && ips.private_ipv6.length > 0 ? ips.private_ipv6.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                ipInfoDiv.innerHTML = html;
            } catch (error) {
                ipInfoDiv.innerHTML = '<div class="ip-item"><p class="no-data">è·å–IPä¿¡æ¯å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        // å‘é€æµ‹è¯•é‚®ä»¶
        async function testEmail() {
            showMessage('æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...', 'success');

            try {
                const response = await fetch('/api/test-email', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessage('æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥æ”¶ä»¶ç®±', 'success');
                } else {
                    const error = await response.text();
                    showMessage('å‘é€æµ‹è¯•é‚®ä»¶å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                showMessage('å‘é€æµ‹è¯•é‚®ä»¶æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type + ' show';

            setTimeout(() => {
                messageDiv.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
