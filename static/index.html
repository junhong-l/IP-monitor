<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPåœ°å€ç›‘æ§ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .ip-list {
            margin-top: 15px;
        }

        .ip-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .ip-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .ip-item p {
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }

        .ip-item .no-data {
            color: #999;
            font-style: italic;
        }

        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            border-radius: 12px;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            font-size: 16px;
            font-weight: 500;
            max-width: 80%;
            text-align: center;
        }

        .message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 999;
            display: none;
        }

        .message-overlay.show {
            display: block;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .message.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1099;
            display: none;
            backdrop-filter: blur(2px);
        }

        .confirm-overlay.show {
            display: block;
        }

        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1100;
            display: none;
        }

        .confirm-dialog.show {
            display: block;
            animation: popIn 0.3s ease;
        }

        .confirm-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .confirm-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .confirm-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .confirm-cancel {
            background: #e9ecef;
            color: #495057;
        }

        .confirm-cancel:hover {
            background: #dee2e6;
            transform: translateY(-2px);
        }

        .confirm-ok {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .confirm-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }

        .confirm-ok.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .confirm-ok.primary:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .smtp-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .smtp-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .smtp-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .smtp-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-switch {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: #f0f4ff;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .interval-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .interval-btn {
            padding: 8px 16px;
            border: 2px solid #28a745;
            border-radius: 20px;
            background: white;
            color: #28a745;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .interval-btn:hover {
            background: #28a745;
            color: white;
        }

        .interval-btn.active {
            background: #28a745;
            color: white;
        }

        .ip-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .ip-type-checkbox {
            display: none;
        }

        .ip-type-label {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border: 2px solid #17a2b8;
            border-radius: 20px;
            background: white;
            color: #17a2b8;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .ip-type-label:hover {
            background: #e7f5f8;
        }

        .ip-type-checkbox:checked + .ip-type-label {
            background: #17a2b8;
            color: white;
        }

        .ip-type-label::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-radius: 4px;
            margin-right: 8px;
            display: inline-block;
            transition: all 0.2s;
        }

        .ip-type-checkbox:checked + .ip-type-label::before {
            background: white;
            border-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2317a2b8'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-size: 14px;
            background-position: center;
            background-repeat: no-repeat;
        }

        .monitor-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
        }

        .status-dot.running {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.stopped {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* æ—¥å¿—æŸ¥çœ‹å™¨æ ·å¼ */
        .log-viewer {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .log-entry {
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry.INFO {
            color: #4fc3f7;
        }

        .log-entry.WARN {
            color: #ffb74d;
            background: rgba(255, 183, 77, 0.1);
        }

        .log-entry.ERROR {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }

        .log-time {
            color: #888;
            margin-right: 8px;
        }

        .log-level {
            font-weight: bold;
            margin-right: 8px;
            padding: 1px 6px;
            border-radius: 3px;
        }

        .log-level.INFO {
            background: #0d47a1;
            color: #4fc3f7;
        }

        .log-level.WARN {
            background: #e65100;
            color: #ffb74d;
        }

        .log-level.ERROR {
            background: #b71c1c;
            color: #ef5350;
        }

        .log-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .log-tabs {
            display: flex;
            gap: 0;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .log-tab {
            padding: 8px 16px;
            border: none;
            background: white;
            color: #666;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .log-tab:not(:last-child) {
            border-right: 1px solid #eee;
        }

        .log-tab.active {
            background: #667eea;
            color: white;
        }

        .log-tab:hover:not(.active) {
            background: #f5f5f5;
        }

        .log-action-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .log-action-btn.refresh {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .log-action-btn.refresh:hover {
            background: #667eea;
            color: white;
        }

        .log-config {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
            font-size: 13px;
            color: #666;
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .log-config input {
            width: 50px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .log-config input:focus {
            outline: none;
            border-color: #667eea;
        }

        .log-config-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .log-config-btn.save {
            background: #667eea;
            color: white;
        }

        .log-config-btn.save:hover {
            background: #5a6fd6;
        }

        .log-config-btn.clean {
            background: #ff6b6b;
            color: white;
        }

        .log-config-btn.clean:hover {
            background: #ee5a5a;
        }

        .log-empty {
            text-align: center;
            color: #888;
            padding: 40px;
        }

        /* IPæœåŠ¡ç®¡ç†æ ·å¼ */
        .service-list {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .service-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 12px;
            background: white;
            border-bottom: 1px solid #eee;
            gap: 12px;
        }

        .service-item:last-child {
            border-bottom: none;
        }

        .service-item:hover {
            background: #f8f9fa;
        }

        .service-item.disabled {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .service-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .service-main-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .service-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .service-url {
            color: #666;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .service-sub-row {
            font-size: 12px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .service-sub-row span {
            white-space: nowrap;
        }

        .service-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
            align-self: flex-start;
        }

        .service-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .service-btn.test {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .service-btn.test:hover {
            background: #bbdefb;
        }

        .service-btn.toggle {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #a5d6a7;
        }

        .service-btn.toggle:hover {
            background: #c8e6c9;
        }

        .service-btn.toggle.off {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc80;
        }

        .service-btn.toggle.off:hover {
            background: #ffe0b2;
        }

        .service-btn.delete {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ef9a9a;
        }

        .service-btn.delete:hover {
            background: #ffcdd2;
        }

        .service-btn.priority {
            background: #fff;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 3px 8px;
            font-size: 14px;
            min-width: 28px;
        }

        .service-btn.priority:hover {
            background: #f0f4ff;
        }

        .test-result {
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .test-result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .test-result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .button-group {
                flex-direction: column;
            }

            .btn-secondary {
                margin-left: 0;
            }

            .log-controls {
                flex-direction: column;
            }

            .log-config {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ IPåœ°å€ç›‘æ§ç³»ç»Ÿ</h1>
            <p>è‡ªåŠ¨ç›‘æ§å¹¶é€šçŸ¥IPåœ°å€å˜åŒ–</p>
        </div>

        <div id="message" class="message"></div>
        <div id="messageOverlay" class="message-overlay"></div>

        <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
        <div id="confirmDialog" class="confirm-dialog">
            <div class="confirm-content">
                <div class="confirm-icon">âš ï¸</div>
                <p id="confirmText" class="confirm-text"></p>
                <div class="confirm-buttons">
                    <button class="confirm-btn confirm-cancel" id="confirmCancel">å–æ¶ˆ</button>
                    <button class="confirm-btn confirm-ok" id="confirmOK">ç¡®å®š</button>
                </div>
            </div>
        </div>
        <div id="confirmOverlay" class="confirm-overlay"></div>

        <!-- é…ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ“§ é‚®ä»¶é…ç½®</h2>
            <form id="configForm">
                <div class="form-group">
                    <label for="senderEmail">å‘ä»¶äººé‚®ç®±ï¼š</label>
                    <input type="email" id="senderEmail" required placeholder="example@gmail.com">
                </div>

                <div class="form-group">
                    <label for="senderPassword">é‚®ç®±å¯†ç /æˆæƒç ï¼š</label>
                    <input type="password" id="senderPassword" placeholder="ç•™ç©ºåˆ™ä¿æŒä¸å˜">
                    <small>å¯¹äºGmailã€QQé‚®ç®±ç­‰ï¼Œéœ€è¦ä½¿ç”¨æˆæƒç è€Œéç™»å½•å¯†ç </small>
                </div>

                <div class="form-group">
                    <label for="smtpServer">SMTPæœåŠ¡å™¨å¿«æ·é…ç½®ï¼š</label>
                    <div class="smtp-presets">
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.qq.com', 587)">ğŸ“§ QQé‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.163.com', 587)">ğŸ“§ 163é‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.gmail.com', 587)">ğŸ“§ Gmail</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.exmail.qq.com', 587)">ğŸ“§ è…¾è®¯ä¼ä¸šé‚®</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp-mail.outlook.com', 587)">ğŸ“§ Outlook</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.126.com', 587)">ğŸ“§ 126é‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.sina.com', 587)">ğŸ“§ æ–°æµªé‚®ç®±</button>
                        <button type="button" class="smtp-btn" onclick="setSmtp('smtp.aliyun.com', 465)">ğŸ“§ é˜¿é‡Œäº‘é‚®ç®±</button>
                    </div>
                    <input type="text" id="smtpServer" required placeholder="smtp.gmail.com" style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label for="smtpPort">SMTPç«¯å£ï¼š</label>
                    <input type="number" id="smtpPort" required placeholder="587">
                    <small>å¸¸ç”¨ç«¯å£: 587(TLS), 465(SSL), 25(éåŠ å¯†)</small>
                </div>

                <div class="form-group">
                    <label for="recipients">æ”¶ä»¶äººé‚®ç®±ï¼š</label>
                    <textarea id="recipients" required placeholder="æ¯è¡Œä¸€ä¸ªé‚®ç®±åœ°å€&#10;example1@gmail.com&#10;example2@gmail.com"></textarea>
                    <small>å¯ä»¥è®¾ç½®å¤šä¸ªæ”¶ä»¶äººï¼Œæ¯è¡Œä¸€ä¸ªé‚®ç®±åœ°å€</small>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button type="button" class="btn btn-secondary" onclick="testEmail()">âœ‰ï¸ å‘é€æµ‹è¯•é‚®ä»¶</button>
                </div>
            </form>
        </div>

        <!-- ç›‘æ§è®¾ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>âš™ï¸ ç›‘æ§è®¾ç½®</h2>
            <div class="form-group">
                <label>ç›‘æ§æ¨¡å¼ï¼š</label>
                <div class="mode-switch">
                    <button type="button" class="mode-btn" id="modeManual" onclick="setMode(false)">ğŸ–ï¸ æ‰‹åŠ¨æ¨¡å¼</button>
                    <button type="button" class="mode-btn" id="modeAuto" onclick="setMode(true)">â° è‡ªåŠ¨æ¨¡å¼</button>
                </div>
                <small>æ‰‹åŠ¨æ¨¡å¼éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ£€æŸ¥ï¼Œè‡ªåŠ¨æ¨¡å¼ä¼šå®šæ—¶æ£€æŸ¥IPå˜åŒ–</small>
            </div>

            <div class="form-group">
                <label>ç›‘æ§IPç±»å‹ï¼š</label>
                <div class="ip-type-selector">
                    <input type="checkbox" id="monitorPublicIPv4" class="ip-type-checkbox" value="public_ipv4" checked>
                    <label for="monitorPublicIPv4" class="ip-type-label">ğŸŒ å…¬ç½‘IPv4</label>
                    
                    <input type="checkbox" id="monitorPublicIPv6" class="ip-type-checkbox" value="public_ipv6" checked>
                    <label for="monitorPublicIPv6" class="ip-type-label">ğŸŒ å…¬ç½‘IPv6</label>
                    
                    <input type="checkbox" id="monitorPrivateIPv4" class="ip-type-checkbox" value="private_ipv4" checked>
                    <label for="monitorPrivateIPv4" class="ip-type-label">ğŸ  ç§ç½‘IPv4</label>
                    
                    <input type="checkbox" id="monitorPrivateIPv6" class="ip-type-checkbox" value="private_ipv6" checked>
                    <label for="monitorPrivateIPv6" class="ip-type-label">ğŸ  ç§ç½‘IPv6</label>
                </div>
                <small>é€‰æ‹©éœ€è¦ç›‘æ§çš„IPç±»å‹ï¼Œå½“é€‰ä¸­çš„IPç±»å‹å‘ç”Ÿå˜åŒ–æ—¶ä¼šå‘é€é€šçŸ¥</small>
            </div>

            <div class="form-group" id="intervalGroup" style="display: none;">
                <label for="intervalMinutes">æ£€æµ‹é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                <div class="interval-presets">
                    <button type="button" class="interval-btn" onclick="setInterval(5)">5åˆ†é’Ÿ</button>
                    <button type="button" class="interval-btn" onclick="setInterval(10)">10åˆ†é’Ÿ</button>
                    <button type="button" class="interval-btn" onclick="setInterval(30)">30åˆ†é’Ÿ</button>
                    <button type="button" class="interval-btn" onclick="setInterval(60)">1å°æ—¶</button>
                    <button type="button" class="interval-btn" onclick="setInterval(120)">2å°æ—¶</button>
                    <button type="button" class="interval-btn" onclick="setInterval(360)">6å°æ—¶</button>
                </div>
                <input type="number" id="intervalMinutes" min="1" max="1440" value="30" style="margin-top: 10px;">
                <small>è®¾ç½®è‡ªåŠ¨æ£€æµ‹IPå˜åŒ–çš„æ—¶é—´é—´éš”ï¼Œæœ€å°1åˆ†é’Ÿï¼Œæœ€å¤§1440åˆ†é’Ÿï¼ˆ24å°æ—¶ï¼‰</small>
            </div>

            <div id="monitorStatus" class="monitor-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ç›‘æ§çŠ¶æ€: æœªçŸ¥</span>
            </div>

            <div class="button-group" style="margin-top: 15px;">
                <button type="button" class="btn btn-primary" onclick="saveMonitorConfig()">ğŸ’¾ ä¿å­˜ç›‘æ§è®¾ç½®</button>
                <button type="button" class="btn btn-secondary" onclick="checkIPNow()">ğŸ” ç«‹å³æ£€æŸ¥IP</button>
            </div>
        </div>

        <!-- IPä¿¡æ¯å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ” å½“å‰IPåœ°å€ä¿¡æ¯</h2>
            <button class="btn btn-primary" onclick="refreshIPs()" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°IPä¿¡æ¯</button>
            <div id="ipInfo" class="ip-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è·å–IPä¿¡æ¯...</p>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥çœ‹å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="log-controls">
                <div class="log-tabs">
                    <button class="log-tab active" id="tabAppLog" onclick="switchLogTab('app')">åº”ç”¨æ—¥å¿—</button>
                    <button class="log-tab" id="tabFetchLog" onclick="switchLogTab('fetch')">IPè·å–æ—¥å¿—</button>
                </div>
                <button class="log-action-btn refresh" onclick="refreshCurrentLogs()">åˆ·æ–°</button>
                <div class="log-config">
                    <span>æ¸…ç†</span>
                    <input type="number" id="logRetentionHours" min="1" max="8760" value="72">
                    <span>å°æ—¶å‰</span>
                    <button class="log-config-btn save" onclick="saveLogConfig()">ä¿å­˜</button>
                    <button class="log-config-btn clean" onclick="cleanLogsNow()">æ¸…ç†</button>
                </div>
            </div>
            <div id="logViewer" class="log-viewer">
                <div class="log-empty">æš‚æ— æ—¥å¿—</div>
            </div>
        </div>

        <!-- IPæœåŠ¡ç®¡ç†å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ”— IPè·å–æœåŠ¡ç®¡ç†</h2>
            <div class="form-group">
                <label>IPv4 æœåŠ¡åˆ—è¡¨ï¼š</label>
                <div id="ipv4ServiceList" class="service-list"></div>
            </div>
            <div class="form-group">
                <label>IPv6 æœåŠ¡åˆ—è¡¨ï¼š</label>
                <div id="ipv6ServiceList" class="service-list"></div>
            </div>
            
            <h3 style="margin-top: 20px; color: #667eea;">â• æ·»åŠ æ–°æœåŠ¡</h3>
            <div class="form-group">
                <label>æœåŠ¡åç§°ï¼š</label>
                <input type="text" id="newServiceName" placeholder="ä¾‹å¦‚: æˆ‘çš„IPæœåŠ¡">
            </div>
            <div class="form-group">
                <label>æœåŠ¡URLï¼š</label>
                <input type="text" id="newServiceUrl" placeholder="https://example.com/ip">
            </div>
            <div class="form-group">
                <label>IPç±»å‹ï¼š</label>
                <select id="newServiceType">
                    <option value="ipv4">IPv4</option>
                    <option value="ipv6">IPv6</option>
                </select>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="addIPService()">â• æ·»åŠ æœåŠ¡</button>
                <button class="btn btn-secondary" onclick="testNewService()">ğŸ§ª æµ‹è¯•æœåŠ¡</button>
            </div>
            <div id="serviceTestResult" style="margin-top: 15px;"></div>
        </div>

        <!-- å¯¼å…¥å¯¼å‡ºå¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ“¦ é…ç½®å¯¼å…¥å¯¼å‡º</h2>
            <p style="color: #666; margin-bottom: 20px;">å¯¼å‡ºåŒ…å«é‚®ä»¶é…ç½®ã€ç›‘æ§é…ç½®å’ŒIPè·å–æœåŠ¡ã€‚é‚®ç®±å¯†ç /æˆæƒç ä¼šä½¿ç”¨æ‚¨æä¾›çš„å¯†é’¥è¿›è¡ŒAESåŠ å¯†ä¿æŠ¤ã€‚</p>
            
            <div class="export-import-section">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“¤ å¯¼å‡ºé…ç½®</h3>
                <div class="form-group">
                    <label>åŠ å¯†å¯†é’¥ï¼š</label>
                    <input type="password" id="exportKey" placeholder="è¯·è¾“å…¥åŠ å¯†å¯†é’¥ï¼ˆç”¨äºåŠ å¯†é‚®ç®±å¯†ç ï¼‰">
                    <small>æ­¤å¯†é’¥ç”¨äºåŠ å¯†é‚®ç®±å¯†ç /æˆæƒç ï¼Œè¯·ç‰¢è®°æ­¤å¯†é’¥ï¼Œå¯¼å…¥æ—¶éœ€è¦ä½¿ç”¨</small>
                </div>
                <button class="btn btn-primary" onclick="exportConfig()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

            <div class="export-import-section">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“¥ å¯¼å…¥é…ç½®</h3>
                <div class="form-group">
                    <label>é€‰æ‹©é…ç½®æ–‡ä»¶ï¼š</label>
                    <input type="file" id="importFile" accept=".json" style="padding: 10px;">
                </div>
                <div class="form-group">
                    <label>è§£å¯†å¯†é’¥ï¼š</label>
                    <input type="password" id="importKey" placeholder="è¯·è¾“å…¥è§£å¯†å¯†é’¥ï¼ˆå¯¼å‡ºæ—¶ä½¿ç”¨çš„å¯†é’¥ï¼‰">
                    <small>æ­¤å¯†é’¥ç”¨äºè§£å¯†é‚®ç®±å¯†ç /æˆæƒç ï¼Œå¿…é¡»ä¸å¯¼å‡ºæ—¶ä½¿ç”¨çš„å¯†é’¥ä¸€è‡´</small>
                </div>
                <div class="form-group">
                    <label>å¯¼å…¥æ¨¡å¼ï¼š</label>
                    <div style="display: flex; gap: 20px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                            <input type="radio" name="importMode" value="smart" checked style="margin-right: 8px; width: auto;">
                            <span>ğŸ”„ æ™ºèƒ½å¯¼å…¥</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                            <input type="radio" name="importMode" value="overwrite" style="margin-right: 8px; width: auto;">
                            <span>ğŸ”ƒ è¦†ç›–å¯¼å…¥</span>
                        </label>
                    </div>
                    <small id="importModeHint" style="display: block; margin-top: 8px;">æ™ºèƒ½å¯¼å…¥ï¼šä¿ç•™ç°æœ‰IPæœåŠ¡ï¼Œä»…æ–°å¢ä¸å­˜åœ¨çš„æœåŠ¡</small>
                </div>
                <button class="btn btn-primary" onclick="importConfig()">ğŸ“¥ å¯¼å…¥é…ç½®</button>
                <div id="importResult" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®å’ŒIPä¿¡æ¯
        window.onload = function() {
            loadConfig();
            refreshIPs();
            loadMonitorStatus();
            loadLogConfig();
            refreshLogs();
            loadIPServices();
            
            // ç›‘å¬å¯¼å…¥æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('input[name="importMode"]').forEach(radio => {
                radio.addEventListener('change', updateImportModeHint);
            });
        };
        
        // æ›´æ–°å¯¼å…¥æ¨¡å¼æç¤º
        function updateImportModeHint() {
            const mode = document.querySelector('input[name="importMode"]:checked').value;
            const hint = document.getElementById('importModeHint');
            if (mode === 'smart') {
                hint.textContent = 'æ™ºèƒ½å¯¼å…¥ï¼šä¿ç•™ç°æœ‰IPæœåŠ¡ï¼Œä»…æ–°å¢ä¸å­˜åœ¨çš„æœåŠ¡';
                hint.style.color = '#666';
            } else {
                hint.textContent = 'âš ï¸ è¦†ç›–å¯¼å…¥ï¼šå°†åˆ é™¤æ‰€æœ‰ç°æœ‰IPæœåŠ¡ï¼Œç„¶åå¯¼å…¥é…ç½®æ–‡ä»¶ä¸­çš„æœåŠ¡';
                hint.style.color = '#e53935';
            }
        }

        // å½“å‰æ¨¡å¼
        let currentAutoMode = false;

        // è®¾ç½®SMTPé¢„è®¾
        function setSmtp(server, port) {
            document.getElementById('smtpServer').value = server;
            document.getElementById('smtpPort').value = port;
            
            // é«˜äº®å½“å‰é€‰ä¸­çš„æŒ‰é’®
            document.querySelectorAll('.smtp-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            showMessage('å·²é€‰æ‹©: ' + server + ':' + port, 'success');
        }

        // è®¾ç½®ç›‘æ§æ¨¡å¼
        function setMode(autoMode) {
            currentAutoMode = autoMode;
            document.getElementById('modeManual').classList.toggle('active', !autoMode);
            document.getElementById('modeAuto').classList.toggle('active', autoMode);
            document.getElementById('intervalGroup').style.display = autoMode ? 'block' : 'none';
        }

        // è®¾ç½®æ—¶é—´é—´éš”
        function setInterval(minutes) {
            document.getElementById('intervalMinutes').value = minutes;
            document.querySelectorAll('.interval-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // åŠ è½½ç›‘æ§çŠ¶æ€
        async function loadMonitorStatus() {
            try {
                const response = await fetch('/api/monitor/status');
                const status = await response.json();
                
                currentAutoMode = status.auto_mode;
                setMode(status.auto_mode);
                document.getElementById('intervalMinutes').value = status.interval_minutes || 30;
                
                // åŠ è½½ç›‘æ§ç±»å‹
                if (status.monitor_types && status.monitor_types.length > 0) {
                    document.getElementById('monitorPublicIPv4').checked = status.monitor_types.includes('public_ipv4');
                    document.getElementById('monitorPublicIPv6').checked = status.monitor_types.includes('public_ipv6');
                    document.getElementById('monitorPrivateIPv4').checked = status.monitor_types.includes('private_ipv4');
                    document.getElementById('monitorPrivateIPv6').checked = status.monitor_types.includes('private_ipv6');
                }
                
                updateStatusDisplay(status.running);
            } catch (error) {
                console.error('åŠ è½½ç›‘æ§çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(running) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            dot.className = 'status-dot ' + (running ? 'running' : 'stopped');
            
            if (currentAutoMode) {
                text.textContent = running ? 
                    'ç›‘æ§çŠ¶æ€: è‡ªåŠ¨ç›‘æ§è¿è¡Œä¸­ âœ…' : 
                    'ç›‘æ§çŠ¶æ€: è‡ªåŠ¨ç›‘æ§å·²åœæ­¢ â¸ï¸';
            } else {
                text.textContent = 'ç›‘æ§çŠ¶æ€: æ‰‹åŠ¨æ¨¡å¼ ğŸ–ï¸';
            }
        }

        // ä¿å­˜ç›‘æ§é…ç½®
        async function saveMonitorConfig() {
            // è·å–é€‰ä¸­çš„ç›‘æ§ç±»å‹
            const monitorTypes = [];
            if (document.getElementById('monitorPublicIPv4').checked) monitorTypes.push('public_ipv4');
            if (document.getElementById('monitorPublicIPv6').checked) monitorTypes.push('public_ipv6');
            if (document.getElementById('monitorPrivateIPv4').checked) monitorTypes.push('private_ipv4');
            if (document.getElementById('monitorPrivateIPv6').checked) monitorTypes.push('private_ipv6');
            
            if (monitorTypes.length === 0) {
                showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§IPç±»å‹è¿›è¡Œç›‘æ§', 'error');
                return;
            }
            
            const config = {
                auto_mode: currentAutoMode,
                interval_minutes: parseInt(document.getElementById('intervalMinutes').value),
                monitor_types: monitorTypes
            };

            try {
                const response = await fetch('/api/config/monitor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showMessage('ç›‘æ§è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    setTimeout(loadMonitorStatus, 500);
                } else {
                    showMessage('ä¿å­˜ç›‘æ§è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜ç›‘æ§è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }

        // ç«‹å³æ£€æŸ¥IP
        async function checkIPNow() {
            showMessage('æ­£åœ¨æ£€æŸ¥IPåœ°å€...', 'success');
            
            try {
                const response = await fetch('/api/check-ip', { method: 'POST' });
                const result = await response.json();
                
                if (result.changed) {
                    let changeInfo = result.changes.map(c => c.type).join(', ');
                    showMessage(result.message + ' (' + changeInfo + ')', 'success');
                } else {
                    showMessage('æ‰€æœ‰ç›‘æ§çš„IPåœ°å€æ— å˜åŒ–', 'success');
                }
                
                refreshIPs();
            } catch (error) {
                showMessage('æ£€æŸ¥IPå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('senderEmail').value = config.sender_email || '';
                document.getElementById('smtpServer').value = config.smtp_server || '';
                document.getElementById('smtpPort').value = config.smtp_port || 587;
                
                if (config.recipients && config.recipients.length > 0) {
                    document.getElementById('recipients').value = config.recipients.join('\n');
                }
                
                // é«˜äº®åŒ¹é…çš„SMTPé¢„è®¾æŒ‰é’®
                highlightSmtpButton(config.smtp_server);
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }
        
        // é«˜äº®åŒ¹é…çš„SMTPæŒ‰é’®
        function highlightSmtpButton(server) {
            document.querySelectorAll('.smtp-btn').forEach(btn => {
                btn.classList.remove('active');
                // ä»æŒ‰é’®çš„onclickå±æ€§ä¸­æå–æœåŠ¡å™¨åœ°å€è¿›è¡ŒåŒ¹é…
                const onclick = btn.getAttribute('onclick');
                if (onclick && server) {
                    const match = onclick.match(/setSmtp\('([^']+)'/);
                    if (match && match[1] === server) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        // ä¿å­˜é…ç½®
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const recipients = document.getElementById('recipients').value
                .split('\n')
                .map(email => email.trim())
                .filter(email => email.length > 0);

            const config = {
                sender_email: document.getElementById('senderEmail').value,
                sender_password: document.getElementById('senderPassword').value,
                smtp_server: document.getElementById('smtpServer').value,
                smtp_port: parseInt(document.getElementById('smtpPort').value),
                recipients: recipients
            };

            try {
                const response = await fetch('/api/config/email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showMessage('é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    document.getElementById('senderPassword').value = '';
                } else {
                    showMessage('ä¿å­˜é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        });

        // åˆ·æ–°IPä¿¡æ¯
        async function refreshIPs() {
            const ipInfoDiv = document.getElementById('ipInfo');
            ipInfoDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨è·å–IPä¿¡æ¯...</p></div>';

            try {
                const response = await fetch('/api/ips');
                const ips = await response.json();

                let html = '';

                html += '<div class="ip-item">';
                html += '<h4>ğŸŒ å…¬ç½‘ IPv4</h4>';
                html += '<p>' + (ips.public_ipv4 && ips.public_ipv4.length > 0 ? ips.public_ipv4.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                html += '<div class="ip-item">';
                html += '<h4>ğŸŒ å…¬ç½‘ IPv6</h4>';
                html += '<p>' + (ips.public_ipv6 && ips.public_ipv6.length > 0 ? ips.public_ipv6.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                html += '<div class="ip-item">';
                html += '<h4>ğŸ  ç§æœ‰ IPv4</h4>';
                html += '<p>' + (ips.private_ipv4 && ips.private_ipv4.length > 0 ? ips.private_ipv4.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                html += '<div class="ip-item">';
                html += '<h4>ğŸ  ç§æœ‰ IPv6</h4>';
                html += '<p>' + (ips.private_ipv6 && ips.private_ipv6.length > 0 ? ips.private_ipv6.join(', ') : '<span class="no-data">æœªæ£€æµ‹åˆ°</span>') + '</p>';
                html += '</div>';

                ipInfoDiv.innerHTML = html;
            } catch (error) {
                ipInfoDiv.innerHTML = '<div class="ip-item"><p class="no-data">è·å–IPä¿¡æ¯å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        // å‘é€æµ‹è¯•é‚®ä»¶
        async function testEmail() {
            showMessage('æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...', 'success');

            try {
                const response = await fetch('/api/test-email', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessage('æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼è¯·æ£€æŸ¥æ”¶ä»¶ç®±', 'success');
                } else {
                    const error = await response.text();
                    showMessage('å‘é€æµ‹è¯•é‚®ä»¶å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                showMessage('å‘é€æµ‹è¯•é‚®ä»¶æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        let messageTimer = null;
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            const overlay = document.getElementById('messageOverlay');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (messageTimer) {
                clearTimeout(messageTimer);
                messageTimer = null;
            }
            
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type + ' show';
            overlay.classList.add('show');

            const closeMessage = () => {
                messageDiv.classList.remove('show');
                overlay.classList.remove('show');
                if (messageTimer) {
                    clearTimeout(messageTimer);
                    messageTimer = null;
                }
            };

            // ç‚¹å‡»é®ç½©å…³é—­
            overlay.onclick = closeMessage;

            // ç‚¹å‡»å¼¹çª—æœ¬èº«ä¹Ÿå…³é—­
            messageDiv.onclick = closeMessage;

            // 5ç§’åè‡ªåŠ¨å…³é—­
            messageTimer = setTimeout(closeMessage, 5000);
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showConfirm(text, options = {}) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('confirmDialog');
                const overlay = document.getElementById('confirmOverlay');
                const textEl = document.getElementById('confirmText');
                const okBtn = document.getElementById('confirmOK');
                const cancelBtn = document.getElementById('confirmCancel');

                textEl.textContent = text;
                
                // è®¾ç½®æŒ‰é’®æ–‡å­—
                okBtn.textContent = options.okText || 'ç¡®å®š';
                cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
                
                // è®¾ç½®æŒ‰é’®æ ·å¼
                okBtn.className = 'confirm-btn confirm-ok' + (options.type === 'primary' ? ' primary' : '');
                
                // è®¾ç½®å›¾æ ‡
                const iconEl = dialog.querySelector('.confirm-icon');
                if (options.icon) {
                    iconEl.textContent = options.icon;
                } else {
                    iconEl.textContent = options.type === 'primary' ? 'â“' : 'âš ï¸';
                }

                dialog.classList.add('show');
                overlay.classList.add('show');

                const cleanup = () => {
                    dialog.classList.remove('show');
                    overlay.classList.remove('show');
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    overlay.onclick = null;
                };

                okBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };

                overlay.onclick = () => {
                    cleanup();
                    resolve(false);
                };
            });
        }

        // ========== æ—¥å¿—ç›¸å…³å‡½æ•° ==========

        // åŠ è½½æ—¥å¿—é…ç½®
        async function loadLogConfig() {
            try {
                const response = await fetch('/api/logs/config');
                const config = await response.json();
                document.getElementById('logRetentionHours').value = config.retention_hours || 72;
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜æ—¥å¿—é…ç½®
        async function saveLogConfig() {
            const retentionHours = parseInt(document.getElementById('logRetentionHours').value);
            
            if (retentionHours < 1 || retentionHours > 8760) {
                showMessage('æ—¥å¿—ä¿ç•™æ—¶é—´å¿…é¡»åœ¨1-8760å°æ—¶ä¹‹é—´', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/logs/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ retention_hours: retentionHours })
                });
                
                if (response.ok) {
                    showMessage('æ—¥å¿—é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    showMessage('ä¿å­˜æ—¥å¿—é…ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜æ—¥å¿—é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }

        // å½“å‰æ—¥å¿—ç±»å‹
        let currentLogTab = 'app';

        // åˆ‡æ¢æ—¥å¿—æ ‡ç­¾
        function switchLogTab(tab) {
            currentLogTab = tab;
            document.getElementById('tabAppLog').classList.toggle('active', tab === 'app');
            document.getElementById('tabFetchLog').classList.toggle('active', tab === 'fetch');
            refreshCurrentLogs();
        }

        // åˆ·æ–°å½“å‰æ—¥å¿—
        function refreshCurrentLogs() {
            if (currentLogTab === 'app') {
                refreshLogs();
            } else {
                refreshFetchLogs();
            }
        }

        // ç«‹å³æ¸…ç†æ—¥å¿—
        async function cleanLogsNow() {
            const confirmed = await showConfirm('ç¡®å®šè¦ç«‹å³æ¸…ç†è¿‡æœŸæ—¥å¿—å—ï¼Ÿ', {
                icon: 'ğŸ—‘ï¸',
                okText: 'æ¸…ç†',
                type: 'danger'
            });
            if (!confirmed) return;
            
            const hours = document.getElementById('logRetentionHours').value || 72;
            try {
                const response = await fetch('/api/logs/clean', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ retention_hours: parseInt(hours) })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`æ—¥å¿—æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${result.deleted || 0} æ¡è®°å½•`, 'success');
                    refreshCurrentLogs();
                } else {
                    showMessage('æ¸…ç†å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°åº”ç”¨æ—¥å¿—
        async function refreshLogs() {
            const viewer = document.getElementById('logViewer');
            viewer.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨åŠ è½½æ—¥å¿—...</p></div>';
            
            try {
                const response = await fetch('/api/logs?limit=200');
                const entries = await response.json();
                
                if (!entries || entries.length === 0) {
                    viewer.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—è®°å½•</div>';
                    return;
                }
                
                let html = '';
                entries.reverse().forEach(entry => {
                    const levelClass = entry.level || 'INFO';
                    html += `<div class="log-entry ${levelClass}">`;
                    html += `<span class="log-time">${escapeHtml(entry.created_at)}</span>`;
                    html += `<span class="log-level ${levelClass}">${escapeHtml(entry.level)}</span>`;
                    html += `<span class="log-message">${escapeHtml(entry.message)}</span>`;
                    html += '</div>';
                });
                
                viewer.innerHTML = html;
                viewer.scrollTop = viewer.scrollHeight;
            } catch (error) {
                viewer.innerHTML = '<div class="log-empty">åŠ è½½æ—¥å¿—å¤±è´¥: ' + escapeHtml(error.message) + '</div>';
            }
        }

        // åˆ·æ–°IPè·å–æ—¥å¿—
        async function refreshFetchLogs() {
            const viewer = document.getElementById('logViewer');
            viewer.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨åŠ è½½æ—¥å¿—...</p></div>';
            
            try {
                const response = await fetch('/api/logs/fetch?limit=200');
                const entries = await response.json();
                
                if (!entries || entries.length === 0) {
                    viewer.innerHTML = '<div class="log-empty">æš‚æ— IPè·å–æ—¥å¿—</div>';
                    return;
                }
                
                let html = '';
                entries.forEach(entry => {
                    const levelClass = entry.success ? 'INFO' : 'ERROR';
                    const status = entry.success ? 'âœ…' : 'âŒ';
                    const ip = entry.ip || entry.error || 'æ— ';
                    html += `<div class="log-entry ${levelClass}">`;
                    html += `<span class="log-time">${escapeHtml(entry.created_at)}</span>`;
                    html += `<span class="log-level ${levelClass}">[${entry.ip_type}]</span>`;
                    html += `<span class="log-message">${status} ${escapeHtml(entry.service_url)} â†’ ${escapeHtml(ip)} (${entry.duration_ms}ms)</span>`;
                    html += '</div>';
                });
                
                viewer.innerHTML = html;
            } catch (error) {
                viewer.innerHTML = '<div class="log-empty">åŠ è½½æ—¥å¿—å¤±è´¥: ' + escapeHtml(error.message) + '</div>';
            }
        }

        // ========== IPæœåŠ¡ç®¡ç†å‡½æ•° ==========

        // åŠ è½½IPæœåŠ¡åˆ—è¡¨
        async function loadIPServices() {
            try {
                const response = await fetch('/api/ip-services');
                const services = await response.json();
                
                const ipv4List = document.getElementById('ipv4ServiceList');
                const ipv6List = document.getElementById('ipv6ServiceList');
                
                ipv4List.innerHTML = '';
                ipv6List.innerHTML = '';
                
                if (!services || services.length === 0) {
                    ipv4List.innerHTML = '<div class="log-empty">æš‚æ— IPv4æœåŠ¡</div>';
                    ipv6List.innerHTML = '<div class="log-empty">æš‚æ— IPv6æœåŠ¡</div>';
                    return;
                }
                
                services.forEach(svc => {
                    const html = createServiceItem(svc);
                    if (svc.type === 'ipv4') {
                        ipv4List.innerHTML += html;
                    } else {
                        ipv6List.innerHTML += html;
                    }
                });
                
                if (ipv4List.innerHTML === '') ipv4List.innerHTML = '<div class="log-empty">æš‚æ— IPv4æœåŠ¡</div>';
                if (ipv6List.innerHTML === '') ipv6List.innerHTML = '<div class="log-empty">æš‚æ— IPv6æœåŠ¡</div>';
            } catch (error) {
                console.error('åŠ è½½IPæœåŠ¡å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºæœåŠ¡é¡¹HTML
        function createServiceItem(svc) {
            const disabledClass = svc.enabled ? '' : 'disabled';
            const toggleText = svc.enabled ? 'åœç”¨' : 'å¯ç”¨';
            const toggleClass = svc.enabled ? '' : 'off';
            
            // è®¡ç®—æˆåŠŸç‡
            const totalCount = (svc.success_count || 0) + (svc.fail_count || 0);
            const successRate = totalCount > 0 ? Math.round((svc.success_count || 0) / totalCount * 100) : 0;
            const successRateClass = successRate >= 80 ? 'good' : (successRate >= 50 ? 'medium' : 'bad');
            
            // æ ¼å¼åŒ–æœ€åæˆåŠŸæ—¶é—´
            let lastSuccessText = ' - ';
            if (svc.last_success_at) {
                lastSuccessText = formatTime(svc.last_success_at);
            }
            
            // çŠ¶æ€ä¿¡æ¯
            const statsInfo = totalCount > 0 
                ? `æˆåŠŸ${svc.success_count || 0}æ¬¡ / å¤±è´¥${svc.fail_count || 0}æ¬¡`
                : 'æš‚æ— è®°å½•';
            
            return `
                <div class="service-item ${disabledClass}" data-id="${svc.id}">
                    <div class="service-info">
                        <div class="service-main-row">
                            <span class="service-name">${escapeHtml(svc.name)}ï¼š</span>
                            <span class="service-url">${escapeHtml(svc.url)}</span>
                        </div>
                        <div class="service-sub-row" >
                            <span>å¤±è´¥ï¼š${svc.fail_count || 0}æ¬¡</span>
                            <span>ä¸Šæ¬¡æˆåŠŸï¼š${lastSuccessText}</span>
                            ${svc.avg_duration_ms > 0 ? `<span>è®¿é—®ç”¨æ—¶ï¼š${svc.avg_duration_ms}ms</span>` : '<span>è®¿é—®ç”¨æ—¶ï¼š-</span>'}
                            ${svc.last_ip ? `<span>è·å–IPï¼š${svc.last_ip}</span>` : '<span>è·å–IPï¼š-</span>'}
                        </div>
                    </div>
                    <div class="service-actions">
                        <button class="service-btn priority" onclick="changePriority(${svc.id}, 'up')" title="æé«˜ä¼˜å…ˆçº§">â†‘</button>
                        <button class="service-btn priority" onclick="changePriority(${svc.id}, 'down')" title="é™ä½ä¼˜å…ˆçº§">â†“</button>
                        <button class="service-btn test" onclick="testService('${escapeHtml(svc.url)}', '${svc.type}')">æµ‹è¯•</button>
                        <button class="service-btn toggle ${toggleClass}" onclick="toggleService(${svc.id}, ${!svc.enabled}, ${svc.priority})">${toggleText}</button>
                        <button class="service-btn delete" onclick="deleteService(${svc.id})">åˆ é™¤</button>
                    </div>
                </div>
            `;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰
        function formatTime(timeStr) {
            if (!timeStr) return 'æœªçŸ¥';
            const date = new Date(timeStr.replace(' ', 'T') + 'Z');
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
            if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
            if (diffDays < 7) return `${diffDays}å¤©å‰`;
            return timeStr.substring(0, 16);
        }

        // æµ‹è¯•æœåŠ¡
        async function testService(url, type) {
            showMessage('æ­£åœ¨æµ‹è¯•æœåŠ¡...', 'success');
            
            try {
                const response = await fetch('/api/ip-services/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, type })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… æµ‹è¯•æˆåŠŸ! IP: ${result.ip} (${result.duration_ms}ms)`, 'success');
                } else {
                    showMessage(`âŒ æµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
                }
                loadIPServices(); // åˆ·æ–°æœåŠ¡åˆ—è¡¨
            } catch (error) {
                showMessage('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                loadIPServices(); // åˆ·æ–°æœåŠ¡åˆ—è¡¨
            }
        }

        // æµ‹è¯•æ–°æœåŠ¡
        async function testNewService() {
            const url = document.getElementById('newServiceUrl').value;
            const type = document.getElementById('newServiceType').value;
            const resultDiv = document.getElementById('serviceTestResult');
            
            if (!url) {
                showMessage('è¯·è¾“å…¥æœåŠ¡URL', 'error');
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch('/api/ip-services/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, type })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="test-result success">âœ… æµ‹è¯•æˆåŠŸ! IP: ${result.ip} (${result.duration_ms}ms)</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ·»åŠ IPæœåŠ¡
        async function addIPService() {
            const name = document.getElementById('newServiceName').value;
            const url = document.getElementById('newServiceUrl').value;
            const type = document.getElementById('newServiceType').value;
            
            if (!name || !url) {
                showMessage('è¯·å¡«å†™æœåŠ¡åç§°å’ŒURL', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/ip-services/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url, type, priority: 100 })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`âœ… æ·»åŠ æˆåŠŸ! æµ‹è¯•IP: ${result.test_ip}`, 'success');
                    document.getElementById('newServiceName').value = '';
                    document.getElementById('newServiceUrl').value = '';
                    document.getElementById('serviceTestResult').innerHTML = '';
                    loadIPServices();
                } else {
                    const error = await response.text();
                    showMessage('æ·»åŠ å¤±è´¥: ' + error, 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è°ƒæ•´ä¼˜å…ˆçº§
        async function changePriority(id, direction) {
            try {
                const response = await fetch(`/api/ip-services/get?id=${id}`, {
                    method: 'GET'
                });
                const service = await response.json();
                
                let newPriority = service.priority;
                if (direction === 'up') {
                    newPriority = Math.max(1, service.priority - 1);
                } else {
                    newPriority = service.priority + 1;
                }
                
                const updateResponse = await fetch('/api/ip-services/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, enabled: service.enabled, priority: newPriority })
                });
                
                if (updateResponse.ok) {
                    showMessage('ä¼˜å…ˆçº§å·²è°ƒæ•´', 'success');
                    loadIPServices();
                } else {
                    showMessage('è°ƒæ•´å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('è°ƒæ•´å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ‡æ¢æœåŠ¡çŠ¶æ€
        async function toggleService(id, enabled, priority) {
            try {
                const response = await fetch('/api/ip-services/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, enabled, priority })
                });
                
                if (response.ok) {
                    loadIPServices();
                } else {
                    showMessage('æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤æœåŠ¡
        async function deleteService(id) {
            const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤æ­¤æœåŠ¡å—ï¼Ÿ', {
                icon: 'ğŸ—‘ï¸',
                okText: 'åˆ é™¤',
                type: 'danger'
            });
            if (!confirmed) return;
            
            try {
                const response = await fetch('/api/ip-services/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                
                if (response.ok) {
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    loadIPServices();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== å¯¼å‡ºå¯¼å…¥åŠŸèƒ½ ====================

        // å¯¼å‡ºé…ç½®
        async function exportConfig() {
            const encryptKey = document.getElementById('exportKey').value;
            
            if (!encryptKey) {
                showMessage('è¯·è¾“å…¥åŠ å¯†å¯†é’¥', 'error');
                return;
            }

            if (encryptKey.length < 4) {
                showMessage('åŠ å¯†å¯†é’¥é•¿åº¦è‡³å°‘4ä¸ªå­—ç¬¦', 'error');
                return;
            }

            showMessage('æ­£åœ¨å¯¼å‡ºé…ç½®...', 'success');

            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ encrypt_key: encryptKey })
                });

                if (!response.ok) {
                    const error = await response.text();
                    showMessage('å¯¼å‡ºå¤±è´¥: ' + error, 'error');
                    return;
                }

                const data = await response.json();
                
                // åˆ›å»ºä¸‹è½½
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ip-monitor-config-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage('é…ç½®å¯¼å‡ºæˆåŠŸï¼', 'success');
                document.getElementById('exportKey').value = '';
            } catch (error) {
                showMessage('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å…¥é…ç½®
        async function importConfig() {
            const fileInput = document.getElementById('importFile');
            const decryptKey = document.getElementById('importKey').value;
            const importMode = document.querySelector('input[name="importMode"]:checked').value;
            const resultDiv = document.getElementById('importResult');

            if (!fileInput.files || fileInput.files.length === 0) {
                showMessage('è¯·é€‰æ‹©é…ç½®æ–‡ä»¶', 'error');
                return;
            }

            if (!decryptKey) {
                showMessage('è¯·è¾“å…¥è§£å¯†å¯†é’¥', 'error');
                return;
            }

            const file = fileInput.files[0];
            
            try {
                const fileContent = await file.text();
                let data;
                
                try {
                    data = JSON.parse(fileContent);
                } catch (e) {
                    showMessage('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„JSONæ–‡ä»¶', 'error');
                    return;
                }

                // éªŒè¯æ–‡ä»¶æ ¼å¼
                if (!data.version || !data.email_config) {
                    showMessage('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                    return;
                }

                // ç¡®è®¤å¯¼å…¥
                const modeText = importMode === 'overwrite' ? 'è¦†ç›–å¯¼å…¥' : 'æ™ºèƒ½å¯¼å…¥';
                const modeWarning = importMode === 'overwrite' 
                    ? '\n\nâš ï¸ æ³¨æ„ï¼šè¦†ç›–æ¨¡å¼å°†åˆ é™¤æ‰€æœ‰ç°æœ‰IPæœåŠ¡ï¼' 
                    : '\n\næ™ºèƒ½æ¨¡å¼ï¼šä¿ç•™ç°æœ‰æœåŠ¡ï¼Œä»…æ–°å¢ä¸å­˜åœ¨çš„æœåŠ¡';
                
                const confirmed = await showConfirm(
                    `ç¡®å®šè¦${modeText}é…ç½®å—ï¼Ÿ\n\nå¯¼å‡ºæ—¶é—´: ${data.export_time || 'æœªçŸ¥'}\nIPæœåŠ¡æ•°é‡: ${(data.ip_services || []).length}ä¸ª${modeWarning}`,
                    {
                        icon: importMode === 'overwrite' ? 'âš ï¸' : 'ğŸ“¥',
                        okText: `ç¡®å®š${modeText}`,
                        type: importMode === 'overwrite' ? 'warning' : 'primary'
                    }
                );
                
                if (!confirmed) return;

                resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        decrypt_key: decryptKey,
                        import_mode: importMode,
                        data: data
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="test-result error">âŒ å¯¼å…¥å¤±è´¥: ${escapeHtml(error)}</div>`;
                    showMessage('å¯¼å…¥å¤±è´¥: ' + error, 'error');
                    return;
                }

                const result = await response.json();
                resultDiv.innerHTML = `<div class="test-result success">âœ… ${escapeHtml(result.message)}</div>`;
                showMessage(result.message, 'success');

                // æ¸…ç©ºè¾“å…¥
                fileInput.value = '';
                document.getElementById('importKey').value = '';

                // åˆ·æ–°é¡µé¢æ•°æ®
                loadConfig();
                loadMonitorStatus();
                loadIPServices();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ å¯¼å…¥å¤±è´¥: ${escapeHtml(error.message)}</div>`;
                showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
